---
- name: Create configuration directories
  file:
    dest: "{{ item }}"
    state: directory
  with_items:
    - "{{ varnish_vcl_dir }}"
  tags:
    - conf
    - varnish

- name: Stat secret remote file
  stat: 
    path: "{{ varnish_management_console_secret_file }}" 
  register: secret_file
  changed_when: no
  tags:
    - conf
    - varnish

- name: Read secret remote file if it exists
  shell: cat {{ varnish_management_console_secret_file }}
  register: secret_remote
  when: secret_file.stat.exists
  changed_when: no
  tags:
    - conf
    - varnish

- name: Create/read secret local file
  shell: echo {{ lookup('password', secret + '/credentials/varnish/secret chars=ascii_letters,digits,hexdigits') }}
  register: secret_local
  changed_when: no
  tags:
    - conf
    - varnish

- name: Copy secret key file if needed
  shell: echo {{ lookup('password', secret + '/credentials/varnish/secret chars=ascii_letters,digits,hexdigits') }} > {{ varnish_management_console_secret_file }}
  when: secret_remote is not defined or secret_local.stdout != secret_remote.stdout
  tags:
    - conf
    - varnish

- name: Copy Varnish init script
  command: "cp /lib/systemd/system/varnish.service /etc/systemd/system/varnish.service"
  args:
    creates: /etc/systemd/system/varnish.service
  tags:
    - systemd
    - conf
    - varnish

- name: Add env file from Varnish package
  lineinfile:
    dest: /etc/systemd/system/varnish.service
    follow: yes
    insertafter: "^\\[Service\\]$"
    state: present
    line: "EnvironmentFile=/etc/default/varnish"
    backup: yes
  tags:
    - systemd
    - conf
    - varnish

- name: Replace stock command line
  replace:
    dest: /etc/systemd/system/varnish.service
    follow: yes
    regexp: "^ExecStart=/usr/sbin/varnishd.*$"
    replace: "ExecStart=/usr/sbin/varnishd $DAEMON_OPTS"
  tags:
    - systemd
    - conf
    - varnish

- name: Configure Varnish
  template:
    src: varnish.conf.j2
    dest: "{{ varnish_conf_file }}"
  notify:
    - Reload systemd
  tags:
    - systemd
    - conf
    - varnish

- name: Create vcl
  template:
    src: "{{ varnish_template_name + '.vcl.j2' }}"
    dest: "{{ varnish_vcl_dir }}/{{ varnish_template_name }}.vcl"
  notify: 
    - Restart varnish
  tags:
    - conf
    - varnish
