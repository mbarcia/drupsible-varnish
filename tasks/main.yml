---
- name: Gather facts of designated backend servers
  setup:
  delegate_to: "{{ item }}"
  delegate_facts: True
  with_items: "{{ groups[varnish_deploy_group] }}"

- set_fact:
    varnish_ferm_dependent_rules_exported: "{{ varnish_ferm_dependent_rules }}"

- include: apt-repo.yml
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

- name: Install packages
  package:
    name: "{{ item }}"
    state: latest
  with_items:
  - 'python-pycurl'
  - varnish

- include: prepare.yml

- include: configure-systemd.yml
  when: ansible_distribution_release == 'jessie' or ansible_distribution_release == 'vivid'

- include: configure.yml
  when: ansible_distribution_release != 'jessie' and ansible_distribution_release != 'vivid'

- include: vmods.yml

- include: vcl.yml

- include: vcl-drupsible.yml
  when: varnish_template_name == 'drupsible'
